<div class="appointments-container" [class.resizing]="isResizing">
  <!-- Modern Header -->
  <div class="appointments-header">
    <!-- Top Row: Title and Action Buttons -->
    <div class="header-top" [@titleAnim]="toolbarState" *ngIf="selectedDate">
      <div class="header-title">
        <i class="pi pi-calendar"></i>
        <h2>Raspored za zaposlene</h2>
      </div>

      <div class="action-buttons">
        <p-button 
          icon="pi pi-upload" 
          label="Masovni unos"
          [rounded]="true"
          severity="secondary"
          (onClick)="openBulkAppointments()"
          class="bulk-btn">
        </p-button>

        <p-button 
          icon="pi pi-bell" 
          label="Obavesti waitlist"
          [rounded]="true"
          (onClick)="openWaitlistNotifyDialog()"
          class="notify-btn">
        </p-button>
      </div>
    </div>

    <!-- Bottom Row: Facility, Date, and Work Hours -->
    <div class="header-bottom" [@dateAnim]="toolbarState">
      <!-- Facility Selector -->
      <div class="facility-section">
        <p-select 
          [formControl]="facilityControl"
          [options]="facilities"
          optionLabel="name"
          optionValue="_id"
          placeholder="Izaberi objekat"
          styleClass="facility-select">
        </p-select>
        
        <div class="work-hours-badge" *ngIf="currentFacility">
          <i class="pi pi-clock"></i>
          <span>{{ workHoursString }}</span>
        </div>
      </div>

      <!-- Date Navigation -->
      <div class="date-navigation">
        <p-button 
          icon="pi pi-chevron-left" 
          [rounded]="true"
          [text]="true"
          (onClick)="shiftDate(-1)"
          class="nav-btn">
        </p-button>

        <p-datepicker 
          [formControl]="dateControl"
          (onSelect)="onDateChange($event)"
          placeholder="Izaberi datum"
          dateFormat="dd.mm.yy"
          [showIcon]="true"
          inputId="appointment-date"
          styleClass="date-picker">
        </p-datepicker>

        <p-button 
          icon="pi pi-chevron-right" 
          [rounded]="true"
          [text]="true"
          (onClick)="shiftDate(1)"
          class="nav-btn">
        </p-button>

        <p-button 
          icon="pi pi-calendar" 
          label="Danas"
          [rounded]="true"
          (onClick)="setToday()"
          class="today-btn">
        </p-button>
      </div>
    </div>
  </div>

  <ng-container *ngIf="loading">
    <div class="loading-spinner-container">
      <div class="spinner"></div>
      <div class="loading-text">Uƒçitavanje rasporeda...</div>
    </div>
  </ng-container>
  <ng-container *ngIf="!loading && selectedDate && animateSchedule">
    <div class="schedule-grid" [@scheduleChange]="selectedDate.getTime()">
      <!-- Zaglavlje -->
      <div class="grid-header">
        <div class="time-header-cell"></div>
        <div class="employee-header-cell" *ngFor="let emp of employees">
          <img [src]="emp.avatarUrl ? emp.avatarUrl : 'user-profile-image.png'" alt="{{ emp.firstName }}" class="avatar"
               (error)="emp.avatarUrl = 'assets/default-avatar.png'" />
          <span class="employee-name">{{ emp.firstName }}</span>
        </div>
      </div>

      <!-- Telo grida -->
      <div class="grid-body" #gridBody [style.height.px]="gridBodyHeight">
        <!-- Horizontalne linije -->
        <div class="horizontal-lines">
          <ng-container *ngFor="let t of timeSlots; let i = index">
            <div
              class="horizontal-line"
              *ngIf="i < slotCount - 1"
              [style.top.%]="(i / (slotCount - 1)) * 100"
            ></div>
          </ng-container>
        </div>

        <!-- Vremenska kolona -->
        <div class="time-column" #timeColumn>
          <ng-container *ngFor="let t of timeSlots; let i = index">
            <div
              class="time-cell"
              [style.top.%]="(i / (slotCount - 1)) * 100"
              [style.transform]="'translateY(-100%)'"
            >
              <span>{{ formatTime(t) }}</span>
            </div>
          </ng-container>
        </div>

        <!-- Kolone zaposlenih -->
        <div class="employee-columns" #employeeColumns>
          <div class="employee-column"
               *ngFor="let emp of employees; let i = index"
               [attr.data-employee-id]="emp._id"
               [ngClass]="{ 'not-working': isColumnDisabled(emp) }"
               [class.disabled]="isColumnDisabled(emp)"
               #firstEmployeeColumn=""
               (click)="!isColumnDisabled(emp) && onEmptyColumnClick(emp, $event)">

            <!-- OVERLAYI PRVI! -->
            <div *ngIf="emp.workingShift"
                 class="not-working-overlay"
                 [style.top.%]="0"
                 [style.height.%]="calculateOverlayTop(emp.workingShift.startHour)">
            </div>
            <div *ngIf="emp.workingShift"
                 class="not-working-overlay"
                 [style.top.%]="calculateOverlayTop(emp.workingShift.endHour)"
                 [style.height.%]="calculateOverlayHeight(emp.workingShift.endHour, workEndHour)">
            </div>

            <!-- SVE OSTALO POSLE OVERLAYA -->
            <ng-container *ngFor="let t of timeSlots">
              <div
                class="time-slot"
                [class.unavailable]="!isSlotAvailable(emp, t)"
                [matTooltip]="formatTime(t)"
                [matTooltipDisabled]="
                  isDragging ||
                  isResizing ||
                  !isSlotAvailable(emp, t) ||
                  isSlotCovered(emp, t)
                "
                matTooltipPosition="right"
                [style.pointerEvents]="
                  isSlotAvailable(emp, t) && !isSlotCovered(emp, t) ? 'auto' : 'none'
                "
                [style.height.px]="gridBodyHeight / slotCount"
                ></div>
            </ng-container>

            <div class="appointment-block"
              *ngFor="let ap of getAppointmentsForEmployee(emp._id || ''); trackBy: trackByAppointmentId"
              [attr.data-appointment-id]="ap.id"
              [style.top.%]="calculateTop(ap.startHour)"
              [style.height.%]="calculateHeight(ap.startHour, ap.endHour)"
              [style.width.%]="100 / getAppointmentOverlapCount(ap, emp._id || '')"
              [style.left.%]="getAppointmentOverlapIndex(ap, emp._id || '') * (100 / getAppointmentOverlapCount(ap, emp._id || ''))"
              [matTooltip]="formatTime(ap.startHour) + ' - ' + formatTime(ap.endHour)"
              matTooltipPosition="above"
              [matTooltipDisabled]="isDragging"
              [class.paid]="ap.paid"
              [class.fiscalized]="ap.sale?.fiscal?.status === 'success'"
              [class.cancelled]="ap.cancelled && !ap.paid && ap.sale?.fiscal?.status !== 'success'"
              (click)="onAppointmentClick(ap, $event); $event.stopPropagation()"
              >
              <div class="appointment-info">   
                <div class="service">{{ ap.service.name }}</div>
                <div *ngIf="!ap.cancelled">Klijent : {{ap.client.firstName}} {{ap.client.lastName}}</div>
                <div *ngIf="ap.cancelled" style="color: #ff6b6b; font-weight: bold; text-align: center; padding: 4px 0;">OTKAZAN</div>
                <div class="time" *ngIf="!ap.cancelled">
                  {{ formatTime(ap.startHour) }} - {{ formatTime(ap.endHour) }}
                </div>
                <div class="date" *ngIf="!ap.cancelled">
                  {{ ap.date | date : "dd MMM yyyy" }}
                </div>
            <button
              mat-button
              class="pay-btn"
              [ngClass]="{ 'paid': ap.paid, 'fiscalized': ap.sale?.fiscal?.status === 'success', 'cancelled': ap.cancelled }"
              [disabled]="ap.paid || ap.sale?.fiscal?.status === 'success' || ap.cancelled"
              (click)="onPayAppointment(ap, $event)"
            >
              <mat-icon>point_of_sale</mat-icon>
              {{ ap.cancelled ? 'Otk' : (ap.paid ? (ap.sale?.fiscal?.status === 'success' ? 'Fisk.' : 'Napl.') : 'Naplati') }}
            </button>
              </div>
              <div class="resize-handle" 
                   *ngIf="!ap.paid && ap.sale?.fiscal?.status !== 'success' && !ap.cancelled"
                   (click)="$event.stopPropagation()" 
                   (mousedown)="onResizeStart($event, ap)" 
                   (touchstart)="onResizeStart($event, ap)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
  
  <!-- Hidden POS Checkout Component for Angular compiler detection -->
  <app-pos-checkout *ngIf="false" style="display: none !important;"></app-pos-checkout>
</div>