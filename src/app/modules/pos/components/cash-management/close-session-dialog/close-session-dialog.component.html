<div class="close-session-dialog">
  <!-- Dialog Content -->
  <div class="dialog-content">
    
    <!-- Session Info -->
    <p-card class="session-info-card">
      <div class="session-details">
        <div class="detail-row">
          <span class="label">Lokacija:</span>
          <span class="value">{{ data.session.facility?.name || 'N/A' }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Otvorena:</span>
          <span class="value">{{ formatDate(data.session.openedAt) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Blagajnik:</span>
          <span class="value">{{ data.session.openedBy?.firstName }} {{ data.session.openedBy?.lastName }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Početni Float:</span>
          <span class="value amount">{{ formatAmount(data.session.openingFloat) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Očekivani Cash:</span>
          <span class="value amount">{{ formatAmount(data.session.expectedCash) }}</span>
        </div>
      </div>
    </p-card>

    <!-- Closing Form -->
    <form [formGroup]="closeSessionForm" (ngSubmit)="closeSession()">
      <p-floatLabel class="full-width">
        <p-inputNumber 
          formControlName="closingCount" 
          inputId="closingCount"
          [min]="0"
          [step]="1"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="0"
          styleClass="full-width">
        </p-inputNumber>
        <label for="closingCount">Brojani Cash pri zatvaranju (RSD)</label>
      </p-floatLabel>
      <small class="p-error" *ngIf="closeSessionForm.get('closingCount')?.hasError('required') && closeSessionForm.get('closingCount')?.touched">
        {{ getErrorMessage('closingCount') }}
      </small>
      <small class="p-error" *ngIf="closeSessionForm.get('closingCount')?.hasError('min') && closeSessionForm.get('closingCount')?.touched">
        {{ getErrorMessage('closingCount') }}
      </small>

      <p-floatLabel class="full-width">
        <textarea 
          pInputTextarea
          formControlName="note" 
          id="note"
          placeholder="Dodatne napomene pri zatvaranju..."
          [rows]="3"
          class="full-width">
        </textarea>
        <label for="note">Napomena (opciono)</label>
      </p-floatLabel>
    </form>

    <!-- Variance Preview -->
    <div class="variance-preview" *ngIf="closeSessionForm.get('closingCount')?.value">
      <p-card class="variance-card">
        <div class="variance-details">
          <div class="variance-row">
            <span class="label">Očekivani Cash:</span>
            <span class="value">{{ formatAmount(data.session.expectedCash) }}</span>
          </div>
          <div class="variance-row">
            <span class="label">Brojani Cash:</span>
            <span class="value">{{ formatAmount(closeSessionForm.get('closingCount')?.value) }}</span>
          </div>
          <div class="variance-row variance-result">
            <span class="label">Variance:</span>
            <span class="value" [ngClass]="'severity-' + getVarianceSeverity(closeSessionForm.get('closingCount')?.value - data.session.expectedCash)">
              <i class="pi" [ngClass]="getVarianceIcon(closeSessionForm.get('closingCount')?.value - data.session.expectedCash)"></i>
              {{ formatAmount(closeSessionForm.get('closingCount')?.value - data.session.expectedCash) }}
            </span>
          </div>
          <div class="variance-row">
            <span class="label">Procenat Variance:</span>
            <span class="value" [ngClass]="'severity-' + getVarianceSeverity(closeSessionForm.get('closingCount')?.value - data.session.expectedCash)">
              {{ data.session.expectedCash > 0 ? (((closeSessionForm.get('closingCount')?.value - data.session.expectedCash) / data.session.expectedCash) * 100).toFixed(2) : 0 }}%
            </span>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Session Summary -->
    <div *ngIf="sessionSummary" class="session-summary">
      <p-card class="summary-card">
        <ng-template pTemplate="header">
          <div>
            <h3>Sesija Zatvorena</h3>
            <p>{{ formatDate(sessionSummary.closedAt) }}</p>
          </div>
        </ng-template>
        
        <div class="summary-details">
          <div class="summary-row">
            <span class="label">Početni Float:</span>
            <span class="value">{{ formatAmount(sessionSummary.summary.openingFloat) }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Ukupne Prodaje:</span>
            <span class="value">{{ formatAmount(sessionSummary.summary.totalSales) }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Brojani Cash:</span>
            <span class="value">{{ formatAmount(sessionSummary.summary.closingCount) }}</span>
          </div>
          <div class="summary-row variance-row">
            <span class="label">Variance:</span>
            <span class="value" [ngClass]="'severity-' + getVarianceSeverity(sessionSummary.summary.variance)">
              <i class="pi" [ngClass]="getVarianceIcon(sessionSummary.summary.variance)"></i>
              {{ formatAmount(sessionSummary.summary.variance) }}
            </span>
          </div>
          <div class="summary-row">
            <span class="label">Procenat Variance:</span>
            <span class="value" [ngClass]="'severity-' + getVarianceSeverity(sessionSummary.summary.variance)">
              {{ sessionSummary.summary.variancePercentage.toFixed(2) }}%
            </span>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Dialog Actions -->
  <div class="dialog-actions">
    <p-button 
      label="Otkaži" 
      icon="pi pi-times" 
      (onClick)="cancel()"
      [disabled]="processing"
      severity="secondary"
      [text]="true">
    </p-button>
    
    <p-button 
      label="{{ processing ? 'Zatvaranje...' : 'Zatvori Sesiju' }}" 
      icon="pi pi-times" 
      (onClick)="closeSession()"
      [disabled]="closeSessionForm.invalid || processing"
      [loading]="processing"
      severity="danger">
    </p-button>
  </div>
</div>
