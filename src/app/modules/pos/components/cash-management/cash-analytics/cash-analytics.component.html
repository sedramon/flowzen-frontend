<p-toast position="top-right"></p-toast>

<p-card class="cash-analytics">
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="analytics-header">
      <div class="header-content">
        <div class="header-title">
          <i class="pi pi-chart-line header-icon"></i>
          <h1>Cash Analytics</h1>
        </div>
        <div class="header-actions">
          <p-button 
            label="{{ analyticsLoading ? 'Generisanje...' : 'Generiši Analytics' }}" 
            icon="pi pi-refresh" 
            (onClick)="generateAnalytics()"
            [disabled]="analyticsLoading"
            [loading]="analyticsLoading"
            severity="primary"
            [raised]="true">
          </p-button>
          <p-button 
            label="Eksportuj" 
            icon="pi pi-download" 
            (onClick)="exportAnalytics()"
            [disabled]="!analyticsData"
            severity="secondary"
            [text]="true">
          </p-button>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
    <p>Učitavanje podataka...</p>
  </div>

  <!-- Analytics Content -->
  <div *ngIf="!loading" class="analytics-content">
    
    <!-- Filters -->
    <p-card class="filters-card">
      <ng-template pTemplate="header">
        <h3>Filteri</h3>
      </ng-template>
      <form [formGroup]="analyticsForm" class="filters-form">
        <div class="filters-row">
          <p-floatLabel class="filter-field">
            <p-select 
              formControlName="facility" 
              inputId="facility"
              [options]="facilityOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onFilterChange()"
              styleClass="full-width">
            </p-select>
            <label for="facility">Lokacija</label>
          </p-floatLabel>

          <p-floatLabel class="filter-field">
            <p-select 
              formControlName="period" 
              inputId="period"
              [options]="periodOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onFilterChange()"
              styleClass="full-width">
            </p-select>
            <label for="period">Period</label>
          </p-floatLabel>

          <p-floatLabel class="filter-field">
            <p-datepicker 
              formControlName="startDate" 
              inputId="startDate"
              [showIcon]="true"
              dateFormat="dd.mm.yy"
              (onSelect)="onFilterChange()"
              styleClass="full-width">
            </p-datepicker>
            <label for="startDate">Datum od</label>
          </p-floatLabel>

          <p-floatLabel class="filter-field">
            <p-datepicker 
              formControlName="endDate" 
              inputId="endDate"
              [showIcon]="true"
              dateFormat="dd.mm.yy"
              (onSelect)="onFilterChange()"
              styleClass="full-width">
            </p-datepicker>
            <label for="endDate">Datum do</label>
          </p-floatLabel>
        </div>
      </form>
    </p-card>

    <!-- Analytics Data -->
    <div *ngIf="analyticsData" class="analytics-data">
      
      <!-- Key Metrics -->
      <div class="key-metrics">
        <p-card class="metric-card">
          <div class="metric-content">
            <div class="metric-icon">
              <i class="pi pi-file"></i>
            </div>
            <div class="metric-details">
              <div class="metric-value">{{ analyticsData.totalSessions }}</div>
              <div class="metric-label">Ukupno Sesija</div>
            </div>
          </div>
        </p-card>

        <p-card class="metric-card">
          <div class="metric-content">
            <div class="metric-icon">
              <i class="pi pi-dollar"></i>
            </div>
            <div class="metric-details">
              <div class="metric-value">{{ formatAmount(analyticsData.totalCash) }}</div>
              <div class="metric-label">Ukupan Cash</div>
            </div>
          </div>
        </p-card>

         <p-card class="metric-card">
           <div class="metric-content">
             <div class="metric-icon">
               <i class="pi pi-arrow-up"></i>
             </div>
             <div class="metric-details">
               <div class="metric-value">{{ analyticsData.averageTransactionValue | number:'1.2-2' }} RSD</div>
               <div class="metric-label">Prosečna Vrednost</div>
             </div>
           </div>
         </p-card>

        <p-card class="metric-card">
          <div class="metric-content">
            <div class="metric-icon" [ngClass]="'severity-' + getTrendSeverity(analyticsData.varianceTrend)">
              <i class="pi" [ngClass]="getTrendIcon(analyticsData.varianceTrend)"></i>
            </div>
            <div class="metric-details">
              <div class="metric-value" [ngClass]="'severity-' + getTrendSeverity(analyticsData.varianceTrend)">
                {{ analyticsData.averageVariance | number:'1.2-2' }} RSD
              </div>
              <div class="metric-label">Prosečna Variance</div>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Performance Insights -->
      <div class="performance-insights">
        <p-card class="insights-card">
          <ng-template pTemplate="header">
            <h3>Performance Insights</h3>
          </ng-template>
          <div class="insights-content">
            <div class="insight-item">
              <i class="pi pi-star insight-icon"></i>
              <div class="insight-details">
                <div class="insight-title">Najbolja Lokacija</div>
                <div class="insight-value">{{ analyticsData.topPerformingFacility }}</div>
              </div>
            </div>
            
             <div class="insight-item">
               <i class="pi pi-bolt insight-icon"></i>
               <div class="insight-details">
                 <div class="insight-title">Efikasnost Cash Flow-a</div>
                 <div class="insight-value">{{ analyticsData.cashFlowEfficiency | number:'1.0-0' }}%</div>
               </div>
             </div>
          </div>
        </p-card>
      </div>

      <!-- Payment Methods Distribution -->
      <div class="payment-methods">
        <p-card class="payment-card">
          <ng-template pTemplate="header">
            <h3>Distribucija Plaćanja</h3>
          </ng-template>
           <div class="payment-methods-list">
             <div 
               *ngFor="let payment of analyticsData.paymentMethods" 
               class="payment-method-item">
               <div class="method-info">
                 <i class="pi" [ngClass]="getPaymentMethodIcon(payment.method)" class="method-icon"></i>
                 <span class="method-name">{{ getPaymentMethodText(payment.method) }}</span>
               </div>
               <div class="method-stats">
                 <div class="method-amount">{{ formatAmount(payment.amount) }}</div>
                 <div class="method-percentage">{{ payment.percentage }}%</div>
               </div>
               <div class="method-bar">
                 <div 
                   class="method-bar-fill" 
                   [style.width.%]="payment.percentage"
                   [ngClass]="'severity-' + (payment.method === 'cash' ? 'success' : payment.method === 'card' ? 'info' : 'warning')">
                 </div>
               </div>
             </div>
           </div>
        </p-card>
      </div>

      <!-- Recommendations -->
      <div class="recommendations">
        <p-card class="recommendations-card">
          <ng-template pTemplate="header">
            <h3>Preporuke</h3>
          </ng-template>
          <div class="recommendations-list">
            <div 
              *ngFor="let recommendation of analyticsData.recommendations" 
              class="recommendation-item">
              <i class="pi pi-lightbulb recommendation-icon"></i>
              <span class="recommendation-text">{{ recommendation }}</span>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- No Data State -->
    <div *ngIf="!analyticsData && !loading" class="no-data-state">
      <p-card class="no-data-card">
        <div class="no-data-content">
          <i class="pi pi-chart-line no-data-icon"></i>
          <h3>Nema podataka</h3>
          <p>Nema analytics podataka za odabrane kriterijume</p>
          <p-button 
            label="Generiši Analytics" 
            icon="pi pi-refresh" 
            (onClick)="generateAnalytics()"
            severity="primary"
            [raised]="true">
          </p-button>
        </div>
      </p-card>
    </div>
  </div>
</p-card>
