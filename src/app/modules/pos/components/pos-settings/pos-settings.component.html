<mat-card class="pos-settings-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <mat-icon color="accent">settings</mat-icon>
      POS Podešavanja
    </h2>
    <div class="header-actions">
      <mat-form-field appearance="outline" class="facility-selector">
        <mat-label>Objekat</mat-label>
        <mat-select [formControl]="settingsForm.get('facility')!" (selectionChange)="onFacilityChange($event.value)">
          <mat-option *ngFor="let facility of facilities" [value]="facility._id">
            {{ facility.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Učitavanje podešavanja...</p>
  </div>

  <div *ngIf="!loading" class="settings-content">
    <form [formGroup]="settingsForm" class="settings-form">
      <mat-tab-group class="settings-tabs">
        <!-- Payment Methods Tab -->
        <mat-tab label="Načini plaćanja">
          <div class="tab-content">
            <h3>Konfiguracija načina plaćanja</h3>
            <div class="payment-methods-grid">
              <div *ngFor="let method of getPaymentMethods()" class="payment-method-card">
                <div class="method-header">
                  <mat-slide-toggle [formControl]="settingsForm.get('paymentMethods.' + method + '.enabled')!">
                    {{ settingsForm.get('paymentMethods.' + method + '.label')?.value }}
                  </mat-slide-toggle>
                </div>
                <mat-form-field appearance="outline" class="method-label">
                  <mat-label>Naziv</mat-label>
                  <input matInput [formControl]="settingsForm.get('paymentMethods.' + method + '.label')!">
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tax & Discount Tab -->
        <mat-tab label="Porez i popusti">
          <div class="tab-content">
            <h3>Podešavanja poreza i popusta</h3>
            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Podrazumevani porez (%)</mat-label>
                <input matInput type="number" formControlName="defaultTaxRate" min="0" max="100">
                <mat-error *ngIf="settingsForm.get('defaultTaxRate')?.hasError('required')">
                  Porez je obavezan
                </mat-error>
                <mat-error *ngIf="settingsForm.get('defaultTaxRate')?.hasError('min')">
                  Porez ne može biti negativan
                </mat-error>
                <mat-error *ngIf="settingsForm.get('defaultTaxRate')?.hasError('max')">
                  Porez ne može biti veći od 100%
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Maksimalni popust (%)</mat-label>
                <input matInput type="number" formControlName="maxDiscountPercent" min="0" max="100">
                <mat-error *ngIf="settingsForm.get('maxDiscountPercent')?.hasError('required')">
                  Maksimalni popust je obavezan
                </mat-error>
              </mat-form-field>

              <div class="checkbox-field">
                <mat-checkbox formControlName="allowNegativePrice">
                  Dozvoli negativne cene
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Receipt Tab -->
        <mat-tab label="Račun">
          <div class="tab-content">
            <h3>Podešavanja računa</h3>
            <div class="form-grid">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Format broja računa</mat-label>
                <input matInput formControlName="receiptNumberFormat" placeholder="FAC-YYYYMMDD-####">
                <mat-hint>YYYYMMDD - datum, #### - redni broj</mat-hint>
                <mat-error *ngIf="settingsForm.get('receiptNumberFormat')?.hasError('required')">
                  Format broja računa je obavezan
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Zaglavlje računa</mat-label>
                <textarea matInput formControlName="header" rows="3" placeholder="Naziv salona, adresa, telefon..."></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Podnožje računa</mat-label>
                <textarea matInput formControlName="footer" rows="3" placeholder="Hvala na poseti, dobrodošli ponovo..."></textarea>
              </mat-form-field>

              <div class="checkbox-field">
                <mat-checkbox formControlName="showQR">
                  Prikaži QR kod na računu
                </mat-checkbox>
              </div>

              <div class="checkbox-field">
                <mat-checkbox formControlName="showFiscalNumber">
                  Prikaži fiskalni broj
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Fiscalization Tab -->
        <mat-tab label="Fiskalizacija">
          <div class="tab-content">
            <h3>Podešavanja fiskalizacije</h3>
            <div class="form-grid">
              <div class="checkbox-field">
                <mat-checkbox formControlName="enabled">
                  Omogući fiskalizaciju
                </mat-checkbox>
              </div>

              <mat-form-field appearance="outline">
                <mat-label>Provider fiskalizacije</mat-label>
                <mat-select formControlName="provider">
                  <mat-option *ngFor="let provider of getFiscalProviders()" [value]="provider.value">
                    {{ provider.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Timeout (ms)</mat-label>
                <input matInput type="number" formControlName="timeout" min="1000">
                <mat-error *ngIf="settingsForm.get('fiscalization.timeout')?.hasError('min')">
                  Timeout mora biti najmanje 1000ms
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Broj pokušaja</mat-label>
                <input matInput type="number" formControlName="retryCount" min="1" max="10">
                <mat-error *ngIf="settingsForm.get('fiscalization.retryCount')?.hasError('min')">
                  Minimum 1 pokušaj
                </mat-error>
                <mat-error *ngIf="settingsForm.get('fiscalization.retryCount')?.hasError('max')">
                  Maksimum 10 pokušaja
                </mat-error>
              </mat-form-field>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>

      <div class="form-actions">
        <button mat-button type="button" (click)="resetToDefaults()" [disabled]="saving">
          <mat-icon>restore</mat-icon>
          Vrati na podrazumevano
        </button>
        <button mat-raised-button color="primary" (click)="saveSettings()" [disabled]="saving || settingsForm.invalid">
          <mat-icon *ngIf="!saving">save</mat-icon>
          <mat-icon *ngIf="saving" class="spinning">refresh</mat-icon>
          {{ saving ? 'Čuvanje...' : 'Sačuvaj podešavanja' }}
        </button>
      </div>
    </form>
  </div>
</mat-card>