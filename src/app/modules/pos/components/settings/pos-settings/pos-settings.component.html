<p-toast position="top-right"></p-toast>

<p-card class="pos-settings-container">
  <ng-template pTemplate="header">
    <div class="pos-header">
      <h2 class="pos-title">
        <i class="pi pi-cog"></i>
        POS Podešavanja
      </h2>
      <div class="header-actions">
        <p-floatLabel class="facility-selector">
          <p-select
            [options]="facilityOptions"
            optionLabel="label"
            optionValue="value"
            [value]="currentFacility?._id"
            (onChange)="onFacilityChange($event)"
            styleClass="full-width">
          </p-select>
          <label>Objekat</label>
        </p-floatLabel>
      </div>
    </div>
  </ng-template>

  <div class="pos-settings-content">
    <div *ngIf="loading" class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <p>Učitavanje podešavanja...</p>
    </div>

    <div *ngIf="!loading" class="pos-content">
    <form [formGroup]="settingsForm" class="settings-form">
      <p-tabs [(value)]="selectedTab" class="settings-tabs">
        <p-tablist>
          <p-tab value="payment">
            <i class="pi pi-wallet tab-icon"></i>
            Načini plaćanja
          </p-tab>
          <p-tab value="tax">
            <i class="pi pi-percentage tab-icon"></i>
            Porez i popusti
          </p-tab>
          <p-tab value="receipt">
            <i class="pi pi-file tab-icon"></i>
            Račun
          </p-tab>
          <p-tab value="fiscal">
            <i class="pi pi-check-circle tab-icon"></i>
            Fiskalizacija
          </p-tab>
        </p-tablist>
        <p-tabpanels>
          <!-- Payment Methods Tab -->
          <p-tabpanel value="payment">
            <div class="tab-content">
              <div class="section-header">
                <h3>Konfiguracija načina plaćanja</h3>
                <p class="section-description">Podešavanja dostupnih načina plaćanja u POS sistemu</p>
              </div>
              
              <div class="payment-methods-grid">
                <div *ngFor="let method of getPaymentMethodKeys()" class="payment-method-card">
                  <div class="method-header">
                    <div class="toggle-wrapper">
                      <p-checkbox
                        [formControl]="getPaymentMethodControl(method, 'enabled')!"
                        [binary]="true"
                        inputId="enabled-{{method}}">
                      </p-checkbox>
                      <label 
                        for="enabled-{{method}}"
                        class="toggle-label">
                        {{ getPaymentMethodControl(method, 'label')?.value }}
                      </label>
                    </div>
                    <i class="pi {{
                      method === 'cash' ? 'pi-wallet' :
                      method === 'card' ? 'pi-credit-card' :
                      method === 'voucher' ? 'pi-ticket' :
                      method === 'gift' ? 'pi-gift' :
                      method === 'bank' ? 'pi-building' :
                      'pi-ellipsis-h'
                    }} method-icon"></i>
                  </div>
                  <p-floatLabel class="method-label">
                    <input 
                      pInputText
                      [formControl]="getPaymentMethodControl(method, 'label')!"
                      id="label-{{method}}">
                    <label for="label-{{method}}">Prilagođeni naziv</label>
                  </p-floatLabel>
                </div>
              </div>
            </div>
          </p-tabpanel>

          <!-- Tax & Discount Tab -->
          <p-tabpanel value="tax">
            <div class="tab-content">
              <div class="section-header">
                <h3>Podešavanja poreza i popusta</h3>
                <p class="section-description">Konfiguracija osnovnih finansijskih parametara</p>
              </div>
              
              <div class="form-grid">
                <div class="form-card">
                  <i class="pi pi-building card-icon"></i>
                  <p-floatLabel>
                    <p-inputNumber
                      formControlName="defaultTaxRate"
                      inputId="defaultTaxRate"
                      [min]="0"
                      [max]="100"
                      [showButtons]="true"
                      [minFractionDigits]="0"
                      [maxFractionDigits]="2"
                      suffix="%">
                    </p-inputNumber>
                    <label for="defaultTaxRate">Podrazumevani porez (%)</label>
                  </p-floatLabel>
                </div>

                <div class="form-card">
                  <i class="pi pi-tag card-icon"></i>
                  <p-floatLabel>
                    <p-inputNumber
                      formControlName="maxDiscountPercent"
                      inputId="maxDiscountPercent"
                      [min]="0"
                      [max]="100"
                      [showButtons]="true"
                      [minFractionDigits]="0"
                      [maxFractionDigits]="2"
                      suffix="%">
                    </p-inputNumber>
                    <label for="maxDiscountPercent">Maksimalni popust (%)</label>
                  </p-floatLabel>
                </div>

                <div class="form-card checkbox-card">
                  <i class="pi pi-ban card-icon"></i>
                  <div class="checkbox-wrapper">
                    <p-checkbox
                      formControlName="allowNegativePrice"
                      inputId="allowNegativePrice"
                      [binary]="true">
                    </p-checkbox>
                    <label for="allowNegativePrice" class="checkbox-label">
                      <span class="checkbox-label-text">Dozvoli negativne cene</span>
                      <span class="checkbox-hint">Omogućava unos negativnih iznosa za korekcije</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </p-tabpanel>

          <!-- Receipt Tab -->
          <p-tabpanel value="receipt">
            <div class="tab-content">
              <div class="section-header">
                <h3>Podešavanja računa</h3>
                <p class="section-description">Prilagođavanje izgleda i formata fiskalnih računa</p>
              </div>
              
              <div class="form-grid">
                <div class="form-card full-width">
                  <i class="pi pi-list card-icon"></i>
                  <p-floatLabel>
                    <input
                      pInputText
                      formControlName="receiptNumberFormat"
                      id="receiptNumberFormat"
                      placeholder="FAC-YYYYMMDD-####">
                    <label for="receiptNumberFormat">Format broja računa</label>
                  </p-floatLabel>
                  <small class="field-hint">YYYYMMDD - datum, #### - redni broj</small>
                </div>

                <div class="form-card full-width">
                  <i class="pi pi-align-left card-icon"></i>
                  <p-floatLabel>
                    <textarea
                      pInputTextarea
                      formControlName="header"
                      id="header"
                      [rows]="3"
                      placeholder="Naziv salona, adresa, telefon...">
                    </textarea>
                    <label for="header">Zaglavlje računa</label>
                  </p-floatLabel>
                  <small class="field-hint">Prikazuje se na vrhu računa</small>
                </div>

                <div class="form-card full-width">
                  <i class="pi pi-align-justify card-icon"></i>
                  <p-floatLabel>
                    <textarea
                      pInputTextarea
                      formControlName="footer"
                      id="footer"
                      [rows]="3"
                      placeholder="Hvala na poseti, dobrodošli ponovo...">
                    </textarea>
                    <label for="footer">Podnožje računa</label>
                  </p-floatLabel>
                  <small class="field-hint">Prikazuje se na dnu računa</small>
                </div>

                <div class="form-card checkbox-card">
                  <i class="pi pi-qrcode card-icon"></i>
                  <div class="checkbox-wrapper">
                    <p-checkbox
                      formControlName="showQR"
                      inputId="showQR"
                      [binary]="true">
                    </p-checkbox>
                    <label for="showQR" class="checkbox-label">
                      <span class="checkbox-label-text">Prikaži QR kod na računu</span>
                      <span class="checkbox-hint">Omogućava brzu verifikaciju računa</span>
                    </label>
                  </div>
                </div>

                <div class="form-card checkbox-card">
                  <i class="pi pi-file card-icon"></i>
                  <div class="checkbox-wrapper">
                    <p-checkbox
                      formControlName="showFiscalNumber"
                      inputId="showFiscalNumber"
                      [binary]="true">
                    </p-checkbox>
                    <label for="showFiscalNumber" class="checkbox-label">
                      <span class="checkbox-label-text">Prikaži fiskalni broj</span>
                      <span class="checkbox-hint">Obavezno za fiskalizovane račune</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </p-tabpanel>

          <!-- Fiscalization Tab -->
          <p-tabpanel value="fiscal">
            <div class="tab-content">
              <div class="section-header">
                <h3>Podešavanja fiskalizacije</h3>
                <p class="section-description">Konfiguracija fiskalizacije računa i povezivanje sa fiskalnim uređajima</p>
              </div>
              
              <div class="form-grid" formGroupName="fiscalization">
                <div class="form-card checkbox-card full-width">
                  <i class="pi pi-toggle-on card-icon"></i>
                  <div class="checkbox-wrapper">
                    <p-checkbox
                      formControlName="enabled"
                      inputId="fiscalEnabled"
                      [binary]="true">
                    </p-checkbox>
                    <label for="fiscalEnabled" class="checkbox-label">
                      <span class="checkbox-label-text">Omogući fiskalizaciju</span>
                      <span class="checkbox-hint">Aktivira fiskalizaciju svih računa</span>
                    </label>
                  </div>
                </div>

                <div class="form-card">
                  <i class="pi pi-desktop card-icon"></i>
                  <p-floatLabel>
                    <p-select
                      formControlName="provider"
                      inputId="fiscalProvider"
                      [options]="fiscalProviders"
                      optionLabel="label"
                      optionValue="value">
                    </p-select>
                    <label for="fiscalProvider">Provider fiskalizacije</label>
                  </p-floatLabel>
                  <small class="field-hint">Izaberite tip fiskalnog sistema</small>
                </div>

                <div class="form-card">
                  <i class="pi pi-clock card-icon"></i>
                  <p-floatLabel>
                    <p-inputNumber
                      formControlName="timeout"
                      inputId="fiscalTimeout"
                      [min]="1000"
                      [showButtons]="true"
                      suffix="ms">
                    </p-inputNumber>
                    <label for="fiscalTimeout">Timeout (ms)</label>
                  </p-floatLabel>
                  <small class="field-hint">Vreme čekanja odgovora od fiskalnog uređaja</small>
                </div>

                <div class="form-card">
                  <i class="pi pi-replay card-icon"></i>
                  <p-floatLabel>
                    <p-inputNumber
                      formControlName="retryCount"
                      inputId="fiscalRetryCount"
                      [min]="1"
                      [max]="10"
                      [showButtons]="true">
                    </p-inputNumber>
                    <label for="fiscalRetryCount">Broj pokušaja</label>
                  </p-floatLabel>
                  <small class="field-hint">Broj ponovnih pokušaja pri neuspehu</small>
                </div>
              </div>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>

      <div class="form-actions">
        <p-button
          label="Vrati na podrazumevano"
          icon="pi pi-refresh"
          [text]="true"
          [outlined]="true"
          [disabled]="saving"
          (onClick)="resetToDefaults()"
          class="reset-btn">
        </p-button>
        <p-button
          [label]="saving ? 'Čuvanje...' : 'Sačuvaj podešavanja'"
          icon="pi pi-save"
          [loading]="saving"
          [disabled]="saving || settingsForm.invalid || !settingsForm.dirty"
          (onClick)="saveSettings()"
          severity="accent"
          class="save-btn">
        </p-button>
      </div>
    </form>
    </div>
  </div>
</p-card>
