<p-toast position="top-right"></p-toast>

<p-card class="pos-reports-container">
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="pos-header">
      <h2>
        <i class="pi pi-chart-bar"></i>
        POS Izveštaji
      </h2>
      <p-button
        label="Izvezi Excel"
        icon="pi pi-upload"
        class="export-btn"
        (onClick)="exportToExcel()"
        [disabled]="(selectedTab === '0' && dailyReports.length === 0) || (selectedTab === '1' && zReports.length === 0)"
        severity="accent"
        [raised]="true">
      </p-button>
    </div>
  </ng-template>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-grid">
      <p-floatLabel>
        <p-datepicker
          [formControl]="dateFrom"
          inputId="dateFrom"
          (onSelect)="onFilterChange()"
          (onClear)="onFilterChange()"
          [showIcon]="true"
          dateFormat="dd.mm.yy">
        </p-datepicker>
        <label for="dateFrom">Datum od</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-datepicker
          [formControl]="dateTo"
          inputId="dateTo"
          (onSelect)="onFilterChange()"
          (onClear)="onFilterChange()"
          [showIcon]="true"
          dateFormat="dd.mm.yy">
        </p-datepicker>
        <label for="dateTo">Datum do</label>
      </p-floatLabel>

      <p-floatLabel>
        <p-select
          [formControl]="facilityFilter"
          inputId="facility"
          [options]="facilityOptions"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFilterChange()">
        </p-select>
        <label for="facility">Objekat</label>
      </p-floatLabel>
    </div>
  </div>

  <!-- Tabs -->
  <p-tabs [(value)]="selectedTab" (valueChange)="onTabChange($event)" class="pos-reports-tabs">
    <p-tablist>
      <p-tab value="0">Dnevni izveštaji</p-tab>
      <p-tab value="1">Z izveštaji</p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <div class="tab-content">

        <!-- Daily Reports Summary Cards -->
        <div class="summary-cards">
          <p-card class="summary-card">
            <div class="summary-content">
              <div class="summary-icon">
                <i class="pi pi-shopping-cart"></i>
              </div>
              <div class="summary-details">
                <h3>Ukupno transakcija</h3>
                <p class="summary-number">{{ getTotalTransactions() }}</p>
              </div>
            </div>
          </p-card>

          <p-card class="summary-card">
            <div class="summary-content">
              <div class="summary-icon">
                <i class="pi pi-dollar"></i>
              </div>
              <div class="summary-details">
                <h3>Ukupan promet</h3>
                <p class="summary-number">{{ formatCurrency(getTotalSales()) }}</p>
              </div>
            </div>
          </p-card>

          <p-card class="summary-card">
            <div class="summary-content">
              <div class="summary-icon">
                <i class="pi pi-arrow-up"></i>
              </div>
              <div class="summary-details">
                <h3>Neto promet</h3>
                <p class="summary-number">{{ formatCurrency(getNetAmount()) }}</p>
              </div>
            </div>
          </p-card>

          <p-card class="summary-card">
            <div class="summary-content">
              <div class="summary-icon">
                <i class="pi pi-wallet"></i>
              </div>
              <div class="summary-details">
                <h3>Prosečna vrednost</h3>
                <p class="summary-number">{{ formatCurrency(getAverageTransactionValue()) }}</p>
              </div>
            </div>
          </p-card>
        </div>

        <!-- Loading State -->
        <div *ngIf="reportsLoading || todayReportLoading" class="loading-container">
          <p-progressSpinner></p-progressSpinner>
          <p *ngIf="todayReportLoading">Učitavanje današnjeg izveštaja...</p>
          <p *ngIf="reportsLoading && !todayReportLoading">Učitavanje dnevnih izveštaja...</p>
        </div>

        <!-- Daily Reports Table -->
        <div *ngIf="!reportsLoading && !todayReportLoading" class="reports-content">
          <p-table
            [value]="dailyReports"
            [tableStyle]="{ 'min-width': '50rem' }"
            styleClass="reports-table">

            <ng-template pTemplate="header">
              <tr>
                <th>Datum</th>
                <th>Objekat</th>
                <th>Broj prodaja</th>
                <th>Ukupan promet</th>
                <th>Povraćaji</th>
                <th>Neto promet</th>
                <th>Akcije</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-report>
              <tr>
                <td>{{ formatDate(report.date) }}</td>
                <td>{{ report.facility }}</td>
                <td>{{ report.salesCount }}</td>
                <td>{{ formatCurrency(report.totalSales) }}</td>
                <td>{{ formatCurrency(report.totalRefunds) }}</td>
                <td>{{ formatCurrency(report.totalSales - report.totalRefunds) }}</td>
                <td>
                  <p-button
                    icon="pi pi-eye"
                    [text]="true"
                    [rounded]="true"
                    severity="info"
                    pTooltip="Prikaži detalje"
                    tooltipPosition="top"
                    (onClick)="viewReportDetails(report)">
                  </p-button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7">
                  <div class="no-data">
                    <i class="pi pi-chart-bar"></i>
                    <p>Nema podataka za izabrani period</p>
                    <p-button
                      label="Osveži podatke"
                      icon="pi pi-refresh"
                      (onClick)="loadReports()"
                      severity="primary"
                      [text]="true">
                    </p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      </p-tabpanel>

      <!-- Z Reports Tab -->
      <p-tabpanel value="1">
        <div class="tab-content">
          <!-- Z Reports Summary Cards -->
          <div class="summary-cards">
            <p-card class="summary-card">
              <div class="summary-content">
                <div class="summary-icon">
                  <i class="pi pi-file"></i>
                </div>
                <div class="summary-details">
                  <h3>Ukupno sesija</h3>
                  <p class="summary-number">{{ zReports.length }}</p>
                </div>
              </div>
            </p-card>

            <p-card class="summary-card">
              <div class="summary-content">
                <div class="summary-icon">
                  <i class="pi pi-dollar"></i>
                </div>
                <div class="summary-details">
                  <h3>Ukupan promet</h3>
                  <p class="summary-number">{{ formatCurrency(getZTotalSales()) }}</p>
                </div>
              </div>
            </p-card>

            <p-card class="summary-card">
              <div class="summary-content">
                <div class="summary-icon">
                  <i class="pi pi-arrow-up"></i>
                </div>
                <div class="summary-details">
                  <h3>Ukupna varijacija</h3>
                  <p class="summary-number">{{ formatCurrency(getZTotalVariance()) }}</p>
                </div>
              </div>
            </p-card>

            <p-card class="summary-card">
              <div class="summary-content">
                <div class="summary-icon">
                  <i class="pi pi-wallet"></i>
                </div>
                <div class="summary-details">
                  <h3>Prosečna varijacija</h3>
                  <p class="summary-number">{{ formatCurrency(getZAverageVariance()) }}</p>
                </div>
              </div>
            </p-card>
          </div>

          <!-- Loading State -->
          <div *ngIf="zReportsLoading" class="loading-container">
            <p-progressSpinner></p-progressSpinner>
            <p>Učitavanje Z izveštaja...</p>
          </div>

          <!-- Z Reports Table -->
          <div *ngIf="!zReportsLoading" class="reports-content">
            <p-table
              [value]="zReports"
              [tableStyle]="{ 'min-width': '50rem' }"
              styleClass="reports-table">

              <ng-template pTemplate="header">
                <tr>
                  <th>ID sesije</th>
                  <th>Blagajnik</th>
                  <th>Otvaranje</th>
                  <th>Zatvaranje</th>
                  <th>Ukupan promet</th>
                  <th>Varijacija</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-report>
                <tr>
                  <td>{{ report.sessionId?.substring(0, 8) || 'N/A' }}...</td>
                  <td>{{ report.cashier }}</td>
                  <td>{{ formatDateTime(report.openedAt) }}</td>
                  <td>{{ formatDateTime(report.closedAt) }}</td>
                  <td>{{ formatCurrency(report.totalSales) }}</td>
                  <td>
                    <span [class]="report.variance >= 0 ? 'positive' : 'negative'">
                      {{ formatCurrency(report.variance) }}
                    </span>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="6">
                    <div class="no-data">
                      <i class="pi pi-file"></i>
                      <p>Nema zatvorenih sesija za izabrani period</p>
                      <p-button
                        label="Osveži podatke"
                        icon="pi pi-refresh"
                        (onClick)="loadZReports()"
                        severity="primary"
                        [text]="true">
                      </p-button>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</p-card>
