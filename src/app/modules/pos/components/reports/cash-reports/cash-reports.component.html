<p-toast position="top-right"></p-toast>

<p-card class="cash-reports-container">
  <!-- Header -->
  <ng-template pTemplate="header">
    <div class="reports-header">
      <div class="header-content">
        <div class="header-title">
          <i class="pi pi-chart-bar header-icon"></i>
          <h1>Cash Reports</h1>
        </div>
        <div class="header-actions">
          <p-button
            [label]="reportLoading ? 'Generisanje...' : 'Generiši Izveštaj'"
            icon="pi pi-refresh"
            [loading]="reportLoading"
            (onClick)="generateReport()"
            [disabled]="reportLoading"
            severity="primary"
            [raised]="true"
            class="action-button">
          </p-button>
          <p-button
            label="Eksportuj"
            icon="pi pi-download"
            (onClick)="exportReport()"
            [disabled]="dailyReports.length === 0"
            severity="accent"
            class="action-button">
          </p-button>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Content -->
  <div class="cash-reports-content">
    <!-- Loading Spinner -->
    <div *ngIf="loading" class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <p>Učitavanje podataka...</p>
    </div>

    <!-- Reports Content -->
    <div *ngIf="!loading">
      <!-- Filters -->
      <p-card class="filters-card">
        <ng-template pTemplate="header">
          <div class="filters-header">Filteri</div>
        </ng-template>
        <div class="filters-content">
          <form [formGroup]="reportForm" class="filters-form">
            <div class="filters-row">
              <div class="filter-field">
                <p-select
                  formControlName="facility"
                  inputId="facility"
                  [options]="facilityOptions"
                  optionLabel="label"
                  optionValue="value"
                  styleClass="full-width">
                </p-select>
              </div>

              <p-floatLabel class="filter-field">
                <p-datepicker
                  formControlName="startDate"
                  inputId="startDate"
                  [showIcon]="true"
                  dateFormat="dd.mm.yy">
                </p-datepicker>
                <label for="startDate">Datum od</label>
              </p-floatLabel>

              <p-floatLabel class="filter-field">
                <p-datepicker
                  formControlName="endDate"
                  inputId="endDate"
                  [showIcon]="true"
                  dateFormat="dd.mm.yy">
                </p-datepicker>
                <label for="endDate">Datum do</label>
              </p-floatLabel>
            </div>
          </form>
        </div>
      </p-card>

      <!-- Summary Statistics -->
      <div class="summary-stats" *ngIf="dailyReports.length > 0">
        <p-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-receipt"></i>
            </div>
            <div class="stat-details">
              <div class="stat-value">{{ getTotalStats().totalSessions }}</div>
              <div class="stat-label">Ukupno Sesija</div>
            </div>
          </div>
        </p-card>

        <p-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-money-bill"></i>
            </div>
            <div class="stat-details">
              <div class="stat-value">{{ formatAmount(getTotalStats().totalOpeningFloat) }}</div>
              <div class="stat-label">Ukupni Float</div>
            </div>
          </div>
        </p-card>

        <p-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-building"></i>
            </div>
            <div class="stat-details">
              <div class="stat-value">{{ formatAmount(getTotalStats().totalExpectedCash) }}</div>
              <div class="stat-label">Očekivani Cash</div>
            </div>
          </div>
        </p-card>

        <p-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon">
              <i class="pi pi-wallet"></i>
            </div>
            <div class="stat-details">
              <div class="stat-value">{{ formatAmount(getTotalStats().totalActualCash) }}</div>
              <div class="stat-label">Stvarni Cash</div>
            </div>
          </div>
        </p-card>

        <p-card class="stat-card">
          <div class="stat-content">
            <div class="stat-icon" [ngClass]="'severity-' + getVarianceColor(getTotalStats().totalVariance)">
              <i [class]="getVarianceIcon(getTotalStats().totalVariance)"></i>
            </div>
            <div class="stat-details">
              <div class="stat-value" [ngClass]="'severity-' + getVarianceColor(getTotalStats().totalVariance)">
                {{ formatAmount(getTotalStats().totalVariance) }}
              </div>
              <div class="stat-label">Ukupna Variance</div>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Reports Table -->
      <div class="reports-table" *ngIf="dailyReports.length > 0">
        <p-card class="table-card">
          <ng-template pTemplate="header">
            <div class="table-header">Dnevni Izveštaji</div>
          </ng-template>
          <div class="table-content">
            <p-table
              [value]="dailyReports"
              [tableStyle]="{ 'min-width': '50rem' }"
              styleClass="reports-table-element"
              [paginator]="true"
              [rows]="10"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="Prikazano {first} - {last} od {totalRecords} rezultata">
              
              <ng-template pTemplate="header">
                <tr>
                  <th>Datum</th>
                  <th>Lokacija</th>
                  <th>Sesije</th>
                  <th>Float</th>
                  <th>Očekivano</th>
                  <th>Stvarno</th>
                  <th>Variance</th>
                  <th>%</th>
                  <th>Akcije</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-report>
                <tr>
                  <td>{{ formatDate(report.date) }}</td>
                  <td>{{ report.facility }}</td>
                  <td>{{ report.sessionCount }}</td>
                  <td class="amount-cell">{{ formatAmount(report.summary.totalOpeningFloat) }}</td>
                  <td class="amount-cell">{{ formatAmount(report.summary.totalExpectedCash) }}</td>
                  <td class="amount-cell">{{ formatAmount(report.summary.totalActualCash) }}</td>
                  <td class="variance-cell">
                    <div class="variance-content">
                      <i [ngClass]="'pi ' + getVarianceIcon(report.summary.totalVariance) + ' variance-icon severity-' + getVarianceColor(report.summary.totalVariance)"></i>
                      <span [ngClass]="'severity-' + getVarianceColor(report.summary.totalVariance)">
                        {{ formatAmount(report.summary.totalVariance) }}
                      </span>
                    </div>
                  </td>
                  <td class="percentage-cell">
                    <p-tag [severity]="getVarianceColor(report.summary.totalVariance)" class="percentage-chip">
                      {{ (report.summary.variancePercentage || 0).toFixed(2) }}%
                    </p-tag>
                  </td>
                  <td class="action-cell">
                    <p-button
                      icon="pi pi-eye"
                      [text]="true"
                      [rounded]="true"
                      pTooltip="Detalji"
                      class="action-icon">
                    </p-button>
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="9">Nema podataka</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </p-card>
      </div>

      <!-- No Data State -->
      <div *ngIf="dailyReports.length === 0 && !loading" class="no-data-state">
        <p-card class="no-data-card">
          <div class="no-data-content">
            <i class="pi pi-chart-bar no-data-icon"></i>
            <h3>Nema podataka</h3>
            <p>Nema izveštaja za odabrane kriterijume</p>
            <p-button
              label="Generiši Izveštaj"
              icon="pi pi-refresh"
              (onClick)="generateReport()"
              severity="primary"
              [raised]="true"
              class="action-button">
            </p-button>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</p-card>