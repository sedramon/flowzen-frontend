<p-toast position="top-right"></p-toast>

<p-card class="pos-sales-container">
  <!-- Header -->
  <div class="pos-header">
    <h2 class="pos-title">
      <i class="pi pi-shopping-cart"></i>
      POS Prodaja
    </h2>
    <div class="header-actions">
      <p-floatLabel class="facility-selector">
        <p-select 
          [(ngModel)]="selectedFacilityId"
          [options]="facilityOptions"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFacilityChange($event.value)"
          styleClass="full-width">
        </p-select>
        <label>Objekat</label>
      </p-floatLabel>
      <p-button 
        label="Nova prodaja" 
        icon="pi pi-plus" 
        (onClick)="openNewSale()" 
        [disabled]="!currentFacility"
        severity="accent"
        [raised]="true"
        class="new-sale-btn">
      </p-button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
    <p>Učitavanje podataka...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!loading" class="pos-content">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <i class="pi pi-shopping-cart"></i>
          </div>
          <div class="stat-details">
            <div class="stat-label">Ukupno prodaja</div>
            <div class="stat-value">{{ statistics.totalSales }}</div>
          </div>
        </div>
      </p-card>
      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <i class="pi pi-calendar"></i>
          </div>
          <div class="stat-details">
            <div class="stat-label">Današnji promet</div>
            <div class="stat-value">{{ formatCurrency(statistics.todayRevenue) }}</div>
          </div>
        </div>
      </p-card>
      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <i class="pi pi-arrow-up"></i>
          </div>
          <div class="stat-details">
            <div class="stat-label">Prosečna vrednost</div>
            <div class="stat-value">{{ formatCurrency(statistics.averageSale) }}</div>
          </div>
        </div>
      </p-card>
      <p-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon">
            <i class="pi pi-wallet"></i>
          </div>
          <div class="stat-details">
            <div class="stat-label">Ukupan promet</div>
            <div class="stat-value">{{ formatCurrency(statistics.totalRevenue) }}</div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Sales Table -->
    <div class="sales-section">
      <div class="section-header">
        <h3>Poslednje prodaje</h3>
        <p-button 
          label="Osveži" 
          icon="pi pi-refresh" 
          (onClick)="loadSales()"
          severity="secondary"
          [text]="true">
        </p-button>
      </div>
      
      <div *ngIf="sales.length === 0" class="no-data">
        <i class="pi pi-shopping-cart"></i>
        <p>Nema podataka o prodajama</p>
        <p-button 
          label="Kreiraj prvu prodaju" 
          icon="pi pi-plus" 
          (onClick)="openNewSale()"
          severity="accent"
          [text]="true">
        </p-button>
      </div>

      <div *ngIf="sales.length > 0" class="table-container">
        <p-table 
          [value]="sales" 
          [paginator]="true" 
          [rows]="10" 
          [rowsPerPageOptions]="[5, 10, 25, 50]"
          [tableStyle]="{ 'min-width': '50rem' }"
          styleClass="p-datatable-sm sales-table">
          
          <ng-template pTemplate="header">
            <tr>
              <th>Broj računa</th>
              <th>Datum</th>
              <th>Klijent</th>
              <th>Objekat</th>
              <th>Blagajnik</th>
              <th>Status</th>
              <th>Ukupno</th>
              <th>Fiskalizacija</th>
              <th class="actions-column">Akcije</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-sale>
            <tr>
              <!-- Number Column -->
              <td>
                <div class="sale-numbers">
                  <span class="sale-number">{{ sale.number }}</span>
                  <p-tag *ngIf="sale.refund" value="REF" severity="warning" [rounded]="true"></p-tag>
                </div>
              </td>

              <!-- Date Column -->
              <td>{{ formatDate(sale.date) }}</td>

              <!-- Client Column -->
              <td>
                <span *ngIf="sale.client">{{ sale.client.firstName }} {{ sale.client.lastName }}</span>
                <span *ngIf="!sale.client" class="no-client">N/A</span>
              </td>

              <!-- Facility Column -->
              <td>{{ sale.facility?.name || 'N/A' }}</td>

              <!-- Cashier Column -->
              <td>
                <span *ngIf="sale.cashier">{{ sale.cashier.firstName }} {{ sale.cashier.lastName }}</span>
                <span *ngIf="!sale.cashier && getSessionOpenedBy(sale)">{{ getSessionOpenedBy(sale) }}</span>
                <span *ngIf="!sale.cashier && !getSessionOpenedBy(sale)" class="no-cashier">N/A</span>
              </td>

              <!-- Status Column -->
              <td>
                <div class="status-container">
                  <div class="status-row">
                    <span class="status-label">POS:</span>
                    <p-tag 
                      [value]="getStatusText(sale.status)" 
                      [severity]="getStatusSeverity(sale.status)"
                      [rounded]="true">
                    </p-tag>
                  </div>
                  <div *ngIf="sale.refund" class="status-row refund-row">
                    <span class="status-label">REF:</span>
                    <p-tag 
                      [value]="getStatusText(sale.refund.status)" 
                      [severity]="getStatusSeverity(sale.refund.status)"
                      [rounded]="true">
                    </p-tag>
                  </div>
                </div>
              </td>

              <!-- Total Column -->
              <td>
                <span class="total-amount">{{ formatCurrency(sale.summary?.grandTotal || 0) }}</span>
              </td>

              <!-- Fiscal Column -->
              <td>
                <p-tag 
                  [value]="getFiscalStatus(sale.fiscal)" 
                  [severity]="getFiscalSeverity(sale.fiscal)"
                  [rounded]="true">
                </p-tag>
              </td>

              <!-- Actions Column -->
              <td class="actions-column">
                <div class="action-buttons">
                  <p-button 
                    icon="pi pi-eye" 
                    [text]="true"
                    [rounded]="true"
                    severity="info"
                    pTooltip="Pregled"
                    tooltipPosition="top"
                    (onClick)="viewSale(sale)">
                  </p-button>
                  <p-button 
                    icon="pi pi-print" 
                    [text]="true"
                    [rounded]="true"
                    severity="secondary"
                    pTooltip="Štampaj račun"
                    tooltipPosition="top"
                    (onClick)="printReceipt(sale)">
                  </p-button>
                  <p-button 
                    icon="pi pi-undo" 
                    [text]="true"
                    [rounded]="true"
                    severity="warning"
                    pTooltip="Povraćaj"
                    tooltipPosition="top"
                    [disabled]="sale.status === 'refunded' || sale.fiscal?.status !== 'success' || sale.refund"
                    (onClick)="refundSale(sale)">
                  </p-button>
                  <p-button 
                    icon="pi pi-receipt" 
                    [text]="true"
                    [rounded]="true"
                    severity="success"
                    pTooltip="Fiskalizuj"
                    tooltipPosition="top"
                    [disabled]="sale.fiscal?.status === 'success' || sale.status === 'refunded'"
                    (onClick)="fiscalizeSale(sale)">
                  </p-button>
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="9" class="empty-message">
                <div class="empty-state">
                  <i class="pi pi-shopping-cart"></i>
                  <p>Nema podataka o prodajama</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</p-card>
