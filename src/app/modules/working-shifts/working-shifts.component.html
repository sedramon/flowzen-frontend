<div class="main-container">
  <p-toast position="top-right"></p-toast>
  
  <!-- ─────────────────────── FORMULAR ─────────────────────── -->
  <p-card class="shift-form-card">
    <ng-template pTemplate="header">
      <div class="card-header">
        <i class="pi pi-calendar"></i>
        <h2>Pregled radnih dana zaposlenog</h2>
      </div>
    </ng-template>

    <div class="form-content">
      <form [formGroup]="form" (ngSubmit)="loadSchedule()" class="shift-form">
        <div class="form-row">
          <!-- Zaposleni -->
          <div class="form-field">
            <label>Zaposleni</label>
            <p-select 
              formControlName="employee" 
              [options]="employeeOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Izaberi zaposlenog"
              styleClass="form-select">
            </p-select>
          </div>

          <!-- Facility -->
          <div class="form-field">
            <label>Lokacija</label>
            <p-select 
              formControlName="facility" 
              [options]="facilities"
              optionLabel="name"
              optionValue="_id"
              placeholder="Izaberi lokaciju"
              styleClass="form-select">
            </p-select>
          </div>

          <!-- Izbor meseca -->
          <div class="form-field">
            <label>Mesec</label>
            <p-datepicker 
              formControlName="month"
              view="month"
              dateFormat="mm/yy"
              placeholder="Izaberi mesec"
              styleClass="month-calendar"
              (onSelect)="onMonthSelect($event)">
            </p-datepicker>
          </div>
        </div>

        <div class="form-actions">
          <p-button
            type="submit"
            label="Prikaži kalendar"
            icon="pi pi-calendar"
            [disabled]="form.invalid"
            [rounded]="true"
            class="submit-btn">
          </p-button>
        </div>
      </form>
    </div>
  </p-card>

  <!-- ─────────────── KALENDAR  /  UREĐIVANJE SMENA ─────────────── -->
  <div *ngIf="weeks.length" class="calendar-card">
    <p-card class="shift-schedule-card">
      <ng-template pTemplate="header">
        <div class="schedule-header">
          <h3>
            {{ editShiftsMode
              ? 'Uredi smene'
              : scheduleTitle }}
          </h3>
        </div>
      </ng-template>

      <!-- Header: izbor aktivne smene + toggle dugme -->
      <div class="calendar-header-row">
        <p-button 
          [icon]="editShiftsMode ? 'pi pi-calendar' : 'pi pi-pencil'"
          [label]="editShiftsMode ? 'Prikaži raspored' : 'Uredi smene'"
          [rounded]="true"
          severity="secondary"
          (onClick)="toggleEditShifts()"
          styleClass="toggle-btn">
        </p-button>
        
        <div class="active-shift-selector" *ngIf="!editShiftsMode">
          <label>Aktivna smena</label>
          <p-select 
            [(ngModel)]="activeShiftType" 
            [options]="shiftTypes"
            optionLabel="label"
            optionValue="value"
            placeholder="Izaberi smenu"
            styleClass="shift-select">
            <ng-template let-shift pTemplate="item">
              <div class="shift-option">
                <span class="shift-dot-option" [style.background]="shift.color"></span>
                <span>{{ shift.label }}</span>
              </div>
            </ng-template>
            <ng-template let-shift pTemplate="selectedItem">
              <div class="shift-option">
                <span class="shift-dot-option" [style.background]="shift.color"></span>
                <span>{{ shift.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
      </div>

      <!-- ─────────────── REŽIM UREĐIVANJA TIPOVA SMENA ─────────────── -->
      <div *ngIf="editShiftsMode" class="edit-shifts-section">
        <!-- Prikaz radnih sati facility-ja -->
        <div *ngIf="facilityWorkingHours" class="facility-hours-info">
          <i class="pi pi-clock"></i>
          <strong>Radni sati facility-ja:</strong> 
          <span>{{ facilityWorkingHours.opening }}:00 - {{ facilityWorkingHours.closing }}:00</span>
        </div>

        <div class="shifts-edit-container">
          <form
            #shiftFormDir="ngForm"
            [formGroup]="shiftForm"
            (ngSubmit)="saveShift()"
            class="shifts-edit-form"
          >
            <div class="shifts-form-fields">
              <!-- value -->
              <div class="form-field">
                <label>Vrednost</label>
                <p-select 
                  formControlName="value" 
                  [options]="shiftEnumOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Izaberi vrednost"
                  styleClass="form-select">
                </p-select>
              </div>

              <!-- label -->
              <div class="form-field">
                <label>Labela</label>
                <input 
                  pInputText 
                  formControlName="label" 
                  placeholder="Unesi labelu"
                  class="form-input" />
              </div>

              <!-- color -->
              <div class="form-field">
                <label>Boja</label>
                <input 
                  type="color" 
                  formControlName="color" 
                  class="color-input" />
              </div>

              <!-- start -->
              <div class="form-field">
                <label>Početak</label>
                <p-select 
                  formControlName="startHour" 
                  [options]="timeOptions"
                  placeholder="Izaberi početak"
                  styleClass="form-select">
                  <ng-template let-time pTemplate="item">
                    <span>{{ formatTime(time) }}</span>
                  </ng-template>
                </p-select>
              </div>

              <!-- end -->
              <div class="form-field">
                <label>Kraj</label>
                <p-select 
                  formControlName="endHour" 
                  [options]="timeOptions"
                  placeholder="Izaberi kraj"
                  styleClass="form-select">
                  <ng-template let-time pTemplate="item">
                    <span>{{ formatTime(time) }}</span>
                  </ng-template>
                </p-select>
              </div>
            </div>

            <div class="shifts-form-actions">
              <p-button
                type="submit"
                [label]="editingShift ? 'Sačuvaj izmene' : 'Dodaj smenu'"
                icon="pi pi-check"
                [rounded]="true"
                class="submit-btn">
              </p-button>
              <p-button
                *ngIf="editingShift"
                label="Otkaži"
                icon="pi pi-times"
                [rounded]="true"
                severity="secondary"
                [outlined]="true"
                (onClick)="cancelEditShift()"
                styleClass="cancel-btn">
              </p-button>
            </div>
          </form>

          <!-- Lista svih definisanih smena -->
          <div class="shifts-list-wrapper">
            <div class="shifts-list">
              <div class="shift-list-item" *ngFor="let shift of shiftTypes">
                <div class="shift-list-row">
                  <span class="shift-dot" [style.background]="shift.color"></span>
                  <span class="shift-list-label">{{ shift.label }}</span>
                  <span class="shift-list-value">({{ shift.value }})</span>
                  <span
                    *ngIf="shift.startHour !== undefined"
                    class="shift-list-hours"
                  >
                    {{ formatTime(shift.startHour) }} - {{ formatTime(shift.endHour) }}h
                  </span>

                  <div class="shift-list-actions">
                    <p-button
                      icon="pi pi-pencil"
                      [rounded]="true"
                      [text]="true"
                      severity="info"
                      (onClick)="editShift(shift)"
                      [pTooltip]="'Uredi'"
                      styleClass="edit-btn">
                    </p-button>
                    <p-button
                      icon="pi pi-trash"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="deleteShift(shift)"
                      [pTooltip]="'Obriši'"
                      styleClass="delete-btn">
                    </p-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ─────────────────────── KALENDAR ─────────────────────── -->
      <div *ngIf="!editShiftsMode" class="calendar-wrapper">
        <table class="calendar-table">
          <thead>
            <tr>
              <th *ngFor="let d of [0,1,2,3,4,5,6]">
                {{ getWeekdayName(d) }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let week of weeks">
              <td
                *ngFor="let day of week"
                (click)="onDayClick(day)"
                [ngClass]="{ filled: day?.shift, rotate: day?.animate }"
                [style.background]="getShiftType(day?.shift?.shiftType).color"
                class="calendar-day-cell"
              >
                <div class="day-cell" *ngIf="day">
                  <span
                    class="date-number"
                    [ngClass]="{ 'shift-colored': day?.shift }"
                  >{{ day.date.getDate() }}</span>

                  <div *ngIf="day.shift" class="shift-info">
                    <span class="shift-label">
                      {{ getShiftType(day.shift.shiftType).label }}
                    </span>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </p-card>
  </div>
</div>
